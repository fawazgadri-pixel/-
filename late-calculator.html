<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة تأخير الدوام (شهريًا)</title>

  <style>
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin:24px; line-height:1.6; background:#fff;
    }
    .wrap{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 8px; font-size:28px; }
    .muted{ color:#666; font-size:13px; }

    .card{
      border:1px solid #e6e6e6;
      border-radius:16px;
      padding:18px;
      margin:14px 0;
      background:#fff;
    }

    /* ✅ توسيع الفراغات بين الحقول */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 1.2fr 1.2fr auto;
      gap:24px;           /* ⬅️ مسافة أكبر */
      align-items:end;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr 1fr; gap:16px; }
    }

    label{
      display:block;
      font-size:14px;
      color:#222;
      margin-bottom:10px; /* ⬅️ مسافة أوضح بين العنوان والحقل */
    }

    input, button{
      width:100%;
      padding:12px 12px;
      border:1px solid #cfcfcf;
      border-radius:12px;
      font-size:15px;
      background:#fff;
    }
    input:focus{ outline:none; border-color:#111; }
    button{ cursor:pointer; }

    .btn{ background:#111; color:#fff; border-color:#111; padding:12px 16px; }
    .btn2{ background:#fff; }
    .danger{ background:#b00020; color:#fff; border-color:#b00020; }

    .tools{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .tools > *{ flex:1 1 200px; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .kpis{ grid-template-columns:1fr; } }

    .kpi{
      border:1px solid #eee;
      border-radius:14px;
      padding:14px;
      background:#fcfcfc;
    }
    .kpi .v{ font-size:22px; font-weight:800; margin-top:4px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid #eee; padding:10px; text-align:right; }
    th{ background:#fafafa; font-weight:700; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>حاسبة تأخير الدوام (شهريًا)</h1>
    <div class="muted" id="ruleLine"></div>

    <div class="card">
      <div class="grid">
        <div>
          <label>الشهر</label>
          <input id="month" type="month" />
        </div>

        <div>
          <label>التاريخ</label>
          <input id="date" type="date" />
        </div>

        <div>
          <label>وقت البصمة</label>
          <input id="arrival" type="time" step="60" />
        </div>

        <div>
          <label>بداية الدوام (مرن)</label>
          <input id="startTime" type="time" step="60" />
        </div>

        <div>
          <button class="btn" id="add">إضافة</button>
        </div>
      </div>

      <!-- ✅ ترتيب الأزرار كما طلبت -->
      <div class="tools">
        <button class="btn2" id="export">تصدير CSV</button>
        <button class="btn2" id="backup">حفظ نسخة</button>
        <button class="btn2" id="restoreBtn">استيراد نسخة</button>
        <input id="restoreFile" type="file" accept="application/json" style="display:none" />
        <button class="danger" id="clear">مسح بيانات الشهر</button>
      </div>
    </div>

    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <!-- ✅ تعديل العنوان -->
          <div class="muted">إجمالي ساعات التأخير</div>
          <div class="v" id="totalHM">00:00</div>
        </div>

        <div class="kpi">
          <div class="muted">إجمالي التأخير بالدقائق</div>
          <div class="v" id="totalMin">0</div>
        </div>

        <div class="kpi">
          <div class="muted">عدد أيام التأخير</div>
          <div class="v" id="lateDays">0</div>
        </div>

        <div class="kpi">
          <!-- ✅ كل 7 ساعات = يوم -->
          <div class="muted">عدد أيام التأخير في الخصم (كل 7 ساعات = يوم)</div>
          <div class="v" id="lateDaysByHours">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>وقت البصمة</th>
            <th>بداية الدوام</th>
            <th>التأخير (د)</th>
            <th>التأخير (وقت)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="muted">
      مراجع تقنية (MDN):  
      https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/time  
      https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/month  
      https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage  
      https://developer.mozilla.org/en-US/docs/Web/API/Blob  
      https://developer.mozilla.org/en-US/docs/Web/API/FileReader
    </div>
  </div>

  <script>
    // ===== مفاتيح التخزين =====
    const GLOBAL_START_KEY = "latecalc:globalStartTime"; // بداية دوام افتراضية
    function monthKey(ym){ return "latecalc:rows:" + ym; }

    // ===== عناصر الواجهة =====
    const monthEl = document.getElementById("month");
    const dateEl = document.getElementById("date");
    const arrivalEl = document.getElementById("arrival");
    const startEl = document.getElementById("startTime");
    const tbody = document.getElementById("tbody");

    const totalHMEl = document.getElementById("totalHM");
    const totalMinEl = document.getElementById("totalMin");
    const lateDaysEl = document.getElementById("lateDays");
    const lateDaysByHoursEl = document.getElementById("lateDaysByHours");
    const ruleLine = document.getElementById("ruleLine");

    // ===== مساعدات =====
    function getYM(){
      const v = monthEl.value;
      if (v) return v;
      const d = new Date();
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    }

    function loadRows(){
      const raw = localStorage.getItem(monthKey(getYM()));
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }

    function saveRows(rows){
      localStorage.setItem(monthKey(getYM()), JSON.stringify(rows));
    }

    function toMinutes(hhmm){
      if (!hhmm) return 0;
      const [h,m] = hhmm.split(":").map(Number);
      return h*60 + m;
    }

    function toHM(totalMinutes){
      const h = Math.floor(totalMinutes/60);
      const m = totalMinutes % 60;
      return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
    }

    // ===== قواعد التأخير مع بداية دوام مرنة =====
    // - إذا arrival <= start => 0
    // - إذا start < arrival <= start+30 => 30 دقيقة ثابتة
    // - إذا arrival >= start+31 => الفرق الحقيقي بالدقائق
    function calcLateMinutes(arrivalHHMM, startHHMM){
      const start = toMinutes(startHHMM);
      const arr = toMinutes(arrivalHHMM);
      if (arr <= start) return 0;

      const diff = arr - start;
      if (diff >= 1 && diff <= 30) return 30;
      return diff; // 31+
    }

    function loadGlobalStartTime(){
      return localStorage.getItem(GLOBAL_START_KEY) || "10:00";
    }

    function saveGlobalStartTime(v){
      localStorage.setItem(GLOBAL_START_KEY, v);
    }

    function setRuleText(){
      const s = startEl.value || "10:00";
      ruleLine.textContent =
        `القاعدة: بداية الدوام ${s}. إذا البصمة عند/قبل ${s} = 0. من بعده بدقيقة إلى +30 دقيقة = 30 دقيقة تأخير ثابتة. من +31 دقيقة فما بعد = فرق الدقائق الفعلي. (كل 7 ساعات تأخير متراكمة = يوم تأخير).`;
    }

    // ===== عرض البيانات =====
    function render(){
      const rows = loadRows().sort((a,b)=> a.date.localeCompare(b.date));
      tbody.innerHTML = "";

      let sum = 0;      // مجموع دقائق التأخير
      let lateDays = 0; // عدد الأيام التي بها تأخير > 0

      rows.forEach((r, idx) => {
        const late = calcLateMinutes(r.arrival, r.start);
        sum += late;
        if (late > 0) lateDays++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.arrival}</td>
          <td>${r.start}</td>
          <td>${late}</td>
          <td>${toHM(late)}</td>
          <td><button class="btn2" data-del="${idx}">حذف</button></td>
        `;
        tbody.appendChild(tr);
      });

      // ✅ كل 7 ساعات = يوم تأخير
      const DAYS_UNIT_HOURS = 7;
      const daysByHours = Math.floor((sum / 60) / DAYS_UNIT_HOURS);

      totalMinEl.textContent = sum;
      totalHMEl.textContent = toHM(sum);
      lateDaysEl.textContent = lateDays;
      lateDaysByHoursEl.textContent = daysByHours;
    }

    // ===== تهيئة =====
    (function init(){
      const today = new Date();
      const ym = today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,"0");
      const ymd = today.toISOString().slice(0,10);

      monthEl.value = ym;
      dateEl.value = ymd;

      startEl.value = loadGlobalStartTime();
      arrivalEl.value = startEl.value;

      setRuleText();
      render();
    })();

    // ===== تغيير بداية الدوام =====
    startEl.addEventListener("change", () => {
      if (!startEl.value) startEl.value = "10:00";
      saveGlobalStartTime(startEl.value);
      setRuleText();
    });

    // ===== تغيير الشهر =====
    monthEl.addEventListener("change", () => {
      const ym = getYM();
      dateEl.value = ym + "-01";
      startEl.value = loadGlobalStartTime();
      arrivalEl.value = startEl.value;
      setRuleText();
      render();
    });

    // ===== إضافة/تحديث سجل =====
    document.getElementById("add").addEventListener("click", () => {
      const date = dateEl.value;
      const arrival = arrivalEl.value;
      const start = startEl.value || "10:00";

      if (!date || !arrival) return alert("فضلاً أدخل التاريخ ووقت البصمة.");
      const ym = getYM();
      if (!date.startsWith(ym)) return alert("التاريخ يجب أن يكون ضمن الشهر المختار.");

      const rows = loadRows();
      const payload = { date, arrival, start };

      const i = rows.findIndex(x => x.date === date);
      if (i >= 0) rows[i] = payload;
      else rows.push(payload);

      saveRows(rows);
      render();
    });

    // ===== حذف سجل (مفعل) =====
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const idx = Number(btn.getAttribute("data-del"));

      const rows = loadRows().sort((a,b)=> a.date.localeCompare(b.date));
      rows.splice(idx, 1);
      saveRows(rows);
      render();
    });

    // ===== مسح بيانات الشهر =====
    document.getElementById("clear").addEventListener("click", () => {
      const ym = getYM();
      if (confirm("متأكد؟ سيتم مسح بيانات شهر " + ym)) {
        localStorage.removeItem(monthKey(ym));
        render();
      }
    });

    // ===== تصدير CSV =====
    document.getElementById("export").addEventListener("click", () => {
      const rows = loadRows().sort((a,b)=> a.date.localeCompare(b.date));
      const header = ["date","arrival_time","start_time","late_minutes","late_hhmm"];
      const lines = [header.join(",")];

      let sum = 0;
      rows.forEach(r => {
        const late = calcLateMinutes(r.arrival, r.start);
        sum += late;
        lines.push([r.date, r.arrival, r.start, late, toHM(late)].join(","));
      });

      const DAYS_UNIT_HOURS = 7;
      const daysByHours = Math.floor((sum / 60) / DAYS_UNIT_HOURS);

      lines.push(["TOTAL","","",sum,toHM(sum)].join(","));
      lines.push(["DAYS_BY_7HOURS","","",daysByHours,""].join(","));

      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "late_" + getYM() + ".csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ===== حفظ نسخة (JSON) / استيراد نسخة (JSON) =====
    function downloadJSON(filename, dataObj){
      const json = JSON.stringify(dataObj, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    document.getElementById("backup").addEventListener("click", () => {
      const ym = getYM();
      const rows = loadRows();
      const globalStartTime = localStorage.getItem(GLOBAL_START_KEY) || "10:00";

      const payload = {
        app: "late-calculator",
        version: 1,
        saved_at: new Date().toISOString(),
        month: ym,
        globalStartTime,
        rows
      };

      downloadJSON(`late_backup_${ym}.json`, payload);
    });

    const restoreFile = document.getElementById("restoreFile");
    document.getElementById("restoreBtn").addEventListener("click", () => restoreFile.click());

    restoreFile.addEventListener("change", () => {
      const file = restoreFile.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(String(reader.result || "{}"));

          if (!data || data.app !== "late-calculator" || !data.month || !Array.isArray(data.rows)){
            alert("الملف غير صالح أو ليس نسخة من هذا البرنامج.");
            return;
          }

          // استعادة الشهر
          monthEl.value = data.month;
          dateEl.value = data.month + "-01";

          // استعادة بداية الدوام الافتراضية
          const restoredStart = data.globalStartTime || "10:00";
          localStorage.setItem(GLOBAL_START_KEY, restoredStart);
          startEl.value = restoredStart;
          arrivalEl.value = restoredStart;

          // استعادة سجلات الشهر
          localStorage.setItem(monthKey(data.month), JSON.stringify(data.rows));

          setRuleText();
          render();
          alert("تم الاستيراد بنجاح ✅");
        } catch {
          alert("تعذر قراءة الملف. تأكد أنه JSON صحيح.");
        } finally {
          restoreFile.value = "";
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>